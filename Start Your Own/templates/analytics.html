{% extends "base.html" %}

{% block title %}Analytics - Trading Portfolio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-chart-bar"></i> Portfolio Analytics</h1>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

{% if metrics.error %}
<div class="row">
    <div class="col-md-12">
        <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
            <p>{{ metrics.error }}</p>
        </div>
    </div>
</div>
{% elif metrics.message %}
<div class="row">
    <div class="col-md-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Information</h5>
            <p>{{ metrics.message }}</p>
        </div>
    </div>
</div>
{% else %}
<!-- Performance Metrics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Return</h5>
                <h3 class="card-text {{ 'positive' if metrics.total_return >= 0 else 'negative' }}">
                    {{ "%.2f"|format(metrics.total_return * 100) }}%
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Sharpe Ratio</h5>
                <h3 class="card-text {{ 'positive' if metrics.sharpe_ratio >= 0 else 'negative' }}">
                    {{ "%.2f"|format(metrics.sharpe_ratio) }}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Volatility</h5>
                <h3 class="card-text text-warning">
                    {{ "%.2f"|format(metrics.volatility * 100) }}%
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Max Drawdown</h5>
                <h3 class="card-text text-danger">
                    {{ "%.2f"|format(metrics.max_drawdown * 100) }}%
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Equity Growth -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Portfolio Equity Growth</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Initial Equity: ${{ "%.2f"|format(metrics.initial_equity) }}</h6>
                    </div>
                    <div class="col-md-6">
                        <h6>Final Equity: ${{ "%.2f"|format(metrics.final_equity) }}</h6>
                    </div>
                </div>
                <div class="mt-3">
                    <canvas id="equityChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Details -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> Risk Metrics</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <td><strong>Total Return:</strong></td>
                            <td class="{{ 'positive' if metrics.total_return >= 0 else 'negative' }}">
                                {{ "%.2f"|format(metrics.total_return * 100) }}%
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Annualized Return:</strong></td>
                            <td class="{{ 'positive' if metrics.total_return >= 0 else 'negative' }}">
                                {{ "%.2f"|format(metrics.total_return * 252 * 100) }}%
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Volatility (Annualized):</strong></td>
                            <td>{{ "%.2f"|format(metrics.volatility * 100) }}%</td>
                        </tr>
                        <tr>
                            <td><strong>Sharpe Ratio:</strong></td>
                            <td class="{{ 'positive' if metrics.sharpe_ratio >= 0 else 'negative' }}">
                                {{ "%.2f"|format(metrics.sharpe_ratio) }}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Maximum Drawdown:</strong></td>
                            <td class="text-danger">{{ "%.2f"|format(metrics.max_drawdown * 100) }}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Performance Summary</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-lightbulb"></i> Interpretation Guide</h6>
                    <ul class="mb-0">
                        <li><strong>Sharpe Ratio:</strong> Higher is better. Above 1.0 is good, above 2.0 is excellent</li>
                        <li><strong>Volatility:</strong> Lower is generally better, but depends on your risk tolerance</li>
                        <li><strong>Max Drawdown:</strong> Lower is better. Shows the worst peak-to-trough decline</li>
                        <li><strong>Total Return:</strong> Your overall gain/loss percentage</li>
                    </ul>
                </div>
                
                <div class="mt-3">
                    <h6>Risk Assessment:</h6>
                    {% if metrics.sharpe_ratio >= 1.0 %}
                        <span class="badge bg-success">Good Risk-Adjusted Returns</span>
                    {% elif metrics.sharpe_ratio >= 0.5 %}
                        <span class="badge bg-warning">Moderate Risk-Adjusted Returns</span>
                    {% else %}
                        <span class="badge bg-danger">Poor Risk-Adjusted Returns</span>
                    {% endif %}
                    
                    {% if metrics.max_drawdown <= 0.1 %}
                        <span class="badge bg-success">Low Drawdown Risk</span>
                    {% elif metrics.max_drawdown <= 0.2 %}
                        <span class="badge bg-warning">Moderate Drawdown Risk</span>
                    {% else %}
                        <span class="badge bg-danger">High Drawdown Risk</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Portfolio History Link -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body text-center">
                <h5><i class="fas fa-history"></i> View Detailed History</h5>
                <p class="text-muted">See your portfolio's performance over time with detailed daily data</p>
                <a href="{{ url_for('portfolio_history') }}" class="btn btn-primary">
                    <i class="fas fa-chart-area"></i> View Portfolio History
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
{% if not metrics.error and not metrics.message %}
// Create equity growth chart
const ctx = document.getElementById('equityChart').getContext('2d');
const equityChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['Start', 'Current'],
        datasets: [{
            label: 'Portfolio Equity',
            data: [{{ metrics.initial_equity }}, {{ metrics.final_equity }}],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Portfolio Growth'
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
