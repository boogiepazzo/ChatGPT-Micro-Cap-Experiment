{% extends "base.html" %}

{% block title %}Dashboard - Trading Portfolio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-chart-line"></i> Portfolio Dashboard</h1>
            <div>
                <a href="{{ url_for('run_daily_update') }}" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> Run Daily Update
                </a>
                <a href="{{ url_for('trade') }}" class="btn btn-success">
                    <i class="fas fa-plus"></i> New Trade
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Portfolio Value</h5>
                <h3 class="card-text text-primary">${{ "%.2f"|format(total_value) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Cash Balance</h5>
                <h3 class="card-text text-success">${{ "%.2f"|format(cash_balance) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Total Equity</h5>
                <h3 class="card-text text-info">${{ "%.2f"|format(total_equity) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-muted">Positions</h5>
                <h3 class="card-text text-warning">{{ portfolio|length }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Positions -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-list"></i> Current Positions</h5>
            </div>
            <div class="card-body">
                {% if portfolio %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Shares</th>
                                <th>Buy Price</th>
                                <th>Current Price</th>
                                <th>Market Value</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Stop Loss</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for position in portfolio %}
                            <tr>
                                <td>
                                    <strong>{{ position.ticker }}</strong>
                                </td>
                                <td>{{ "%.2f"|format(position.shares) }}</td>
                                <td>${{ "%.2f"|format(position.buy_price) }}</td>
                                <td>
                                    {% if position.current_price > 0 %}
                                        ${{ "%.2f"|format(position.current_price) }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>${{ "%.2f"|format(position.current_value) }}</td>
                                <td class="{{ 'positive' if position.current_pnl >= 0 else 'negative' }}">
                                    ${{ "%.2f"|format(position.current_pnl) }}
                                </td>
                                <td class="{{ 'positive' if position.current_pnl >= 0 else 'negative' }}">
                                    {% if position.buy_price > 0 %}
                                        {{ "%.2f"|format((position.current_price / position.buy_price - 1) * 100) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>
                                    {% if position.stop_loss > 0 %}
                                        ${{ "%.2f"|format(position.stop_loss) }}
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="getPrice('{{ position.ticker }}')">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <a href="{{ url_for('trade') }}?ticker={{ position.ticker }}&action=SELL" 
                                           class="btn btn-outline-danger">
                                            <i class="fas fa-sell"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No positions in portfolio</h5>
                    <p class="text-muted">Start trading to see your positions here</p>
                    <a href="{{ url_for('trade') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Make Your First Trade
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <a href="{{ url_for('trade') }}" class="btn btn-success btn-lg w-100 mb-2">
                            <i class="fas fa-plus"></i><br>Buy Stock
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('trade') }}?action=SELL" class="btn btn-danger btn-lg w-100 mb-2">
                            <i class="fas fa-minus"></i><br>Sell Stock
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('analytics') }}" class="btn btn-info btn-lg w-100 mb-2">
                            <i class="fas fa-chart-bar"></i><br>Analytics
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('portfolio_history') }}" class="btn btn-warning btn-lg w-100 mb-2">
                            <i class="fas fa-history"></i><br>History
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function getPrice(ticker) {
    fetch(`/api/ticker_info/${ticker}`)
        .then(response => response.json())
        .then(data => {
            if (data.current_price) {
                const message = `${ticker} (${data.name})\nCurrent Price: $${data.current_price.toFixed(2)}\nSector: ${data.sector}\nVolume: ${data.volume.toLocaleString()}`;
                alert(message);
            } else {
                alert(`Unable to fetch price for ${ticker}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Fallback to simple price fetch
            fetch(`/api/price/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    if (data.price) {
                        alert(`${ticker} current price: $${data.price.toFixed(2)}`);
                    } else {
                        alert(`Unable to fetch price for ${ticker}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error fetching price');
                });
        });
}

// Auto-refresh prices every 30 seconds
setInterval(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}
